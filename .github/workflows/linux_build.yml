name: Build Flutter Linux RPM

on:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.7'

      - name: Enable Linux Desktop
        run: flutter config --enable-linux-desktop

      - name: Install Linux Desktop Dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            libgtk-3-dev \
            liblzma-dev \
            clang \
            cmake \
            ninja-build \
            pkg-config \
            libglib2.0-dev \
            ruby ruby-dev build-essential

      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Build Flutter Linux App
        run: flutter build linux

      - name: Install fpm
        run: sudo gem install --no-document fpm

      - name: Package RPM
        run: |
          fpm -s dir -t rpm -n my_flutter_app -v 1.0.0 \
            --prefix /opt/my_flutter_app \
            -C build/linux/x64/release/bundle/ .

      - name: Upload RPM artifact
        uses: actions/upload-artifact@v4
        with:
          name: my_flutter_app-rpm
          path: ./*.rpm